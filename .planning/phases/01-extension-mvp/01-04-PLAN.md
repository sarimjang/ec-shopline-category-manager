---
phase: 01-extension-mvp
plan: 04
type: execute
domain: chrome-extension
---

<objective>
Implement Service Worker, complete Extension initialization, and conduct integration testing.

Purpose: Service Worker handles installation events and future background tasks. Integration testing ensures all components work together (manifest → content script → injected script → CategoryManager → storage → popup).

Output:
- `src/background/service-worker.js` - Installation and lifecycle management
- End-to-end testing of category move flow
- Extension ready for loading into Chrome
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
.planning/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@openspec/changes/add-chrome-extension-export-import/design.md
@openspec/changes/add-chrome-extension-export-import/specs/extension-core/spec.md

**Key References from design.md:**
- Service Worker handles onInstall for storage initialization
- Listens to chrome.storage.onChanged for multi-tab sync (Phase 3)
- No long-running operations (MV3 limits SW lifespan)

**Integration Checkpoint:**
After this plan, Extension will be load-testable in Chrome developer mode.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Service Worker with installation and lifecycle management</name>
  <files>src/background/service-worker.js</files>
  <action>
Create Service Worker:

```javascript
// src/background/service-worker.js

// On Extension installation
chrome.runtime.onInstalled.addListener((details) => {
  if (details.reason === 'install') {
    // Initialize storage on first install
    chrome.storage.local.set({
      categoryMoveStats: {
        totalMoves: 0,
        totalTimeSaved: 0,
        lastReset: new Date().toISOString()
      }
    });
    console.log('[Service Worker] Extension installed, storage initialized');
  } else if (details.reason === 'update') {
    console.log('[Service Worker] Extension updated');
  }
});

// Listen for storage changes (prep for Phase 3 multi-tab sync)
chrome.storage.onChanged.addListener((changes, areaName) => {
  if (areaName === 'local') {
    console.log('[Service Worker] Storage changed:', changes);
    // Future: broadcast to other tabs
  }
});

// Handle context menu (prep for Phase 2+ features)
chrome.contextMenus.create({
  id: 'shopline-export',
  title: 'Export Categories (coming in Phase 2)',
  contexts: ['page'],
  documentUrlPatterns: [
    '*://app.shoplineapp.com/admin/*/categories*',
    '*://app.shopline.tw/admin/*/categories*',
    '*://app.shopline.app/admin/*/categories*'
  ]
});

chrome.contextMenus.onClicked.addListener((info, tab) => {
  if (info.menuItemId === 'shopline-export') {
    console.log('[Service Worker] Export menu clicked (Phase 2 feature)');
  }
});

// Handle alarms (unused in Phase 1, ready for Phase 3+)
// chrome.alarms.create('sync-stats', { periodInMinutes: 60 });
```

Avoid: Don't add long-running operations (SW gets suspended). Don't use setTimeout without alarms (won't run reliably). Don't forget console logging for debugging.
  </action>
  <verify>
- service-worker.js loads without syntax errors
- Service Worker can be inspected in chrome://extensions
- Storage initialization on install
  </verify>
  <done>
- Service Worker properly implemented
- Installation event handling working
- Storage initialized on install
- Ready for Chrome loading
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Chrome Extension (Phase 1 MVP) with all components:
- Manifest V3 configuration
- Content script + injected script (AngularJS bridge)
- Storage abstraction layer
- CategoryManager with API integration
- Popup UI with statistics
- Service Worker with installation handling
  </what-built>
  <how-to-verify>
**Manual Load into Chrome:**

1. Open Chrome and go to `chrome://extensions/`
2. Enable "Developer mode" (top right toggle)
3. Click "Load unpacked"
4. Select the project's `src/` directory
5. Extension should appear with Shopline icon

**Verify Installation:**
- Extension icon visible in toolbar
- Click icon → popup should open
- Popup shows: "Moves Today: 0", "Time Saved: 0 min 0 sec"

**Test on Shopline Category Page:**
1. Navigate to Shopline admin category page
2. Open DevTools (F12)
3. Check console:
   - Should see "[Content script loaded on [URL]]"
   - Should see "[Injected] CategoryManager initialized"
4. Verify no errors about permissions or isolated worlds

**Verify Category Move (Optional - if test Shopline instance available):**
1. Move a category (single item)
2. Check popup - "Moves Today: 1" should increment
3. Check console - "[CategoryManager] moveCategory called"
4. Watch localStorage via DevTools → Application → Storage → Extension ID → categoryMoveStats

**Reset Stats:**
1. Click "Reset Stats" in popup
2. Confirm dialog
3. Stats reset to 0
  </how-to-verify>
  <resume-signal>Type "approved" once verified, or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Extension loads in chrome://extensions without errors
- [ ] Popup opens and displays stats correctly
- [ ] Content script detects Shopline category pages
- [ ] No permission warnings or errors
- [ ] Service Worker visible in DevTools
- [ ] Storage working (stats persist after reload)
</verification>

<success_criteria>

- Phase 1 MVP fully implemented and loadable
- All components working together (manifest → content → CategoryManager → storage → popup)
- Category move operation functional
- Stats tracking operational
- Extension ready for Phase 2 development
- No critical console errors
  </success_criteria>

<output>
After completion, create `.planning/phases/01-extension-mvp/01-04-SUMMARY.md`:

# Phase 1.4 Plan 4: Service Worker & Integration Summary

**Service Worker implemented, extension fully integrated and testable in Chrome**

## Accomplishments

- Service Worker handles installation and lifecycle
- Storage initialized on first install
- Context menu scaffold (ready for Phase 2)
- Extension loads successfully in Chrome developer mode
- All components integrated and working

## Files Created/Modified

- `src/background/service-worker.js` - Service Worker with lifecycle management
- `manifest.json` - Final MV3 configuration
- All previous components verified working together

## Decisions Made

- Service Worker kept lightweight (no long-running ops)
- Context menu prepared for Phase 2 export feature
- Installation initializes all necessary storage

## Issues Encountered

None critical

## Next Phase

Phase 1 COMPLETE ✅
- All 12-hour Phase 1 MVP tasks complete
- Extension ready for Web Store preparation
- Ready for Phase 2: Export/Import functionality

**Phase 2 Ready**: `02-01-PLAN.md` - Export functionality (JSON + CSV)
</output>
