---
phase: 01-extension-mvp
plan: 05
type: auto
---

<objective>
Migrate Greasemonkey logic to Chrome Extension with full feature parity.

**Why this matters:**
Phase 1 implemented basic category move. Greasemonkey script has 2700 lines including search, validation, time tracking, and error handling. This plan brings those capabilities into the Extension.

**Output:**
- Full CategoryManager with search, 8-step validation, time tracking
- Complete error classification and recovery
- Feature parity with Greasemonkey version
- All tests passing
</objective>

<context>
@.planning/phases/01-extension-mvp/01-04-SUMMARY.md
@./openspec/changes/migrate-greasemonkey-logic/proposal.md
@./openspec/changes/migrate-greasemonkey-logic/design.md
@./openspec/changes/migrate-greasemonkey-logic/tasks.md
@./openspec/changes/migrate-greasemonkey-logic/specs/extension-core/spec.md
@./openspec/changes/migrate-greasemonkey-logic/specs/category-operations/spec.md
@./openspec/changes/migrate-greasemonkey-logic/specs/category-search/spec.md
@./openspec/changes/migrate-greasemonkey-logic/specs/time-tracking/spec.md
</context>

<tasks>

<task type="checkpoint:human-action">
  <action>Review OpenSpec proposal for migration strategy</action>
  <instructions>
    I've created a comprehensive change proposal in openspec/changes/migrate-greasemonkey-logic/:
    - proposal.md: Why and what we're changing
    - design.md: Technical decisions and risk management
    - tasks.md: 10 implementation stages (65 specific tasks)
    - 4 specs: extension-core, category-operations, category-search, time-tracking

    Read the proposal to understand the migration strategy.
  </instructions>
  <verification>You've read proposal.md and understand the 10-stage approach</verification>
  <resume-signal>Type "approved" when ready, or describe any concerns</resume-signal>
</task>

<task type="auto">
  <name>Stage 1: Migrate CategoryManager to content script</name>
  <action>
    Copy CategoryManager from Greasemonkey script to src/content/content.js.
    
    - Extract full CategoryManager class (all methods: moveCategory, validate, search, track)
    - Replace localStorage references with chrome.storage.local via StorageManager
    - Update API endpoint references to use window._scm_getAngular() from injected.js
    - Keep validation logic (8-step verification)
    - Add CategorySearchManager for real-time search
    - Add TimeSavingsTracker for time calculations
  </action>
  <verify>
    - CategoryManager class compiles without errors
    - All 8 validation steps present
    - Search method exists with debounce
    - Time tracking calculations work
    - Extension loads in chrome://extensions without errors
  </verify>
</task>

<task type="auto">
  <name>Stage 2: Implement injected script AngularJS bridge</name>
  <action>
    Update src/content/injected.js to provide complete AngularJS access:
    
    - Add window._scm_getAngular() function returning scope
    - Expose categoryService for direct API calls
    - Enable CategoryManager to call scope.$apply() for UI updates
    - Log scope access attempts for diagnostics
  </action>
  <verify>
    - _scm_getAngular() returns valid scope object
    - categoryService accessible via scope
    - Content script can read scope data
    - No console errors for scope access
  </verify>
</task>

<task type="auto">
  <name>Stage 3: Update Storage API for complete stats</name>
  <action>
    Enhance StorageManager in src/shared/storage.js:
    
    - Track individual move history (date, category IDs, time saved)
    - Add search query history
    - Add error logs for diagnostics
    - Update stats calculation to use TimeSavingsTracker model
  </action>
  <verify>
    - StorageManager saves and retrieves move history
    - Stats calculation accurate
    - Error logs persist across sessions
    - No storage quota exceeded errors
  </verify>
</task>

<task type="auto">
  <name>Stage 4: Expand Service Worker message routing</name>
  <action>
    Add new message handlers to src/background/service-worker.js:
    
    - getSearchHistory - retrieve search queries
    - recordMove - comprehensive move with validation details
    - classifyError - categorize network/server/client errors
    - getErrorLog - retrieve recent errors
    - validateCategoryPath - pre-flight validation
  </action>
  <verify>
    - All 5 new message handlers work correctly
    - Message routing test passes
    - No messages lost or duplicated
    - Service Worker stays lightweight (no long-running processes)
  </verify>
</task>

<task type="auto">
  <name>Stage 5: Build full search UI in popup</name>
  <action>
    Enhance src/popup/popup.html and popup.js:
    
    - Add real-time search box with 300ms debounce
    - Display category tree (hierarchical view)
    - Show search result count
    - Display top searches from history
    - Add search history management (clear, view top)
  </action>
  <verify>
    - Search box appears in popup
    - Results update in real-time
    - Tree structure displays correctly
    - Search history persists and shows
  </verify>
</task>

<task type="auto">
  <name>Stage 6: Implement error handling and classification</name>
  <action>
    Add error classification to CategoryManager:
    
    - Network errors: timeout, connection refused → retry with exponential backoff
    - Server errors: 500, 502, 503 → retry, then notify user
    - Client errors: 400, 401, 403 → log and fail immediately
    - Scope errors: AngularJS not found → fallback to direct API
    - Store error details for diagnostics
  </action>
  <verify>
    - Each error type classified correctly
    - Retries follow exponential backoff (250ms, 500ms, 1000ms)
    - Error logs stored and retrievable
    - User notified of failures appropriately
  </verify>
</task>

<task type="auto">
  <name>Stage 7: Implement 8-step category move validation</name>
  <action>
    Implement complete validation sequence in CategoryManager:
    
    1. Input validation (IDs, destination)
    2. Pre-flight check (category exists)
    3. Scope verification (AngularJS ready)
    4. Tree validation (no circular deps)
    5. Permission check (user can move)
    6. API request (actual move)
    7. Response verification (success status)
    8. Post-move verification (category in new location)
    
    - Log each step
    - Pre-validation cache for performance
    - Post-validation with retry
  </action>
  <verify>
    - All 8 steps execute in order
    - Validation catches invalid operations
    - Pre and post validation match
    - Performance acceptable (< 500ms per move)
  </verify>
</task>

<task type="auto">
  <name>Stage 8: Add time tracking and statistics</name>
  <action>
    Implement TimeSavingsTracker in CategoryManager:
    
    - Calculate time saved per move (Shopline UI: ~15s, API: ~2s)
    - Track cumulative time saved
    - Update stats on every successful move
    - Display in popup with formatting (min/sec)
    - Reset and export statistics
  </action>
  <verify>
    - Time calculation correct (13s per move)
    - Stats update in real-time
    - Popup displays formatted time correctly
    - Reset clears all stats
    - Export produces valid data
  </verify>
</task>

<task type="auto">
  <name>Stage 9: Integration testing and validation</name>
  <action>
    Test full migration with all components:
    
    - Create test category structure in Shopline dev env
    - Test category move (single, bulk, error cases)
    - Test search with various queries
    - Test validation with invalid inputs
    - Test error recovery and retries
    - Test stats tracking and display
    - Verify all state persists across extension reloads
    - Check no regressions in original Phase 1 functionality
  </action>
  <verify>
    - All category moves work correctly
    - Search returns accurate results
    - Validation blocks invalid operations
    - Errors handled gracefully
    - Stats accurate and persistent
    - Extension remains stable (no crashes)
    - Phase 1 features still work
  </verify>
</task>

<task type="auto">
  <name>Stage 10: Rollback support and documentation</name>
  <action>
    Add rollback capability and document migration:
    
    - Implement pre-move state snapshot (for rollback)
    - Add "Undo last move" button in popup
    - Document CategoryManager API
    - Document error handling strategy
    - Add TypeScript types for all new functions
    - Update README with full feature list
  </action>
  <verify>
    - Rollback function works correctly
    - Documentation complete and accurate
    - TypeScript types added
    - README reflects all features
    - No console warnings
  </verify>
</task>

<task type="checkpoint:human-verify">
  <what-built>
    Full Greasemonkey logic migrated to Chrome Extension:
    - CategoryManager with search, validation, time tracking
    - Error classification and recovery
    - Real-time search UI in popup
    - Stats tracking and display
    - 8-step validation and rollback
  </what-built>
  <how-to-verify>
    1. Load extension in chrome://extensions (Developer mode)
    2. Navigate to Shopline category page
    3. Test category move (should track time saved in popup)
    4. Test search in popup (should update in real-time)
    5. Check error handling (try invalid move)
    6. Verify stats persist after extension reload
    7. Test undo (if implemented)
  </how-to-verify>
  <resume-signal>Type "approved" when all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- All 10 stages completed
- Integration tests passing
- No regressions in Phase 1 functionality
- Extension loads without errors
- All error cases handled gracefully
</verification>

<success_criteria>
- [ ] CategoryManager fully migrated with all features
- [ ] Search UI working with real-time results
- [ ] 8-step validation implemented
- [ ] Error classification and recovery working
- [ ] Time tracking accurate
- [ ] Stats display in popup
- [ ] Rollback capability functional
- [ ] All tests passing
- [ ] Documentation complete
- [ ] Feature parity with Greasemonkey version
</success_criteria>

<output>
Create `.planning/phases/01-extension-mvp/01-05-SUMMARY.md` with:
- What was accomplished (all 10 stages)
- Task commits (each task committed individually)
- Integration test results
- Performance metrics
- Any deviations or adjustments made
- Next phase readiness assessment
</output>
