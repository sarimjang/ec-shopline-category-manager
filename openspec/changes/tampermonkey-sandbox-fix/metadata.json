{
  "id": "tampermonkey-sandbox-fix",
  "title": "Tampermonkey 沙箱 AngularJS 訪問修復",
  "status": "in-progress",
  "created": "2026-01-15T13:00:00Z",
  "updated": "2026-01-15T13:00:00Z",
  "type": "bugfix",
  "priority": "critical",
  "tags": ["bugfix", "tampermonkey", "angularjs", "sandbox", "production"],
  "phases": [
    {
      "name": "Phase 1",
      "description": "程式碼修改 - 加入 getAngular() 和 waitForAngular()",
      "status": "pending"
    },
    {
      "name": "Phase 2",
      "description": "整合測試與驗證",
      "status": "pending"
    },
    {
      "name": "Phase 3",
      "description": "文檔更新與發布",
      "status": "pending"
    }
  ],
  "estimated_effort": "2.5 hours",
  "impact": {
    "users": "all production users",
    "breaking_changes": false,
    "performance": "negligible (< 1ms per call)",
    "severity": "critical - prod version completely broken"
  },
  "dependencies": [
    "time-savings-tracker"
  ],
  "related_issues": [
    "Production 版本無法顯示按鈕",
    "Tampermonkey 沙箱阻擋 window.angular",
    "AngularJS scope 訪問失敗"
  ],
  "technical_notes": [
    "使用 unsafeWindow.angular 跨越 Tampermonkey 沙箱邊界",
    "加入 waitForAngular() 輪詢機制（100ms 間隔，10 秒超時）",
    "修改 4 處 angular.element 直接調用（Line 704, 789, 896, 2413）",
    "在 init() 開頭加入 AngularJS 等待邏輯",
    "保持 @grant GM_registerMenuCommand 以支援 Tampermonkey 選單功能",
    "符合 UserScript 最佳實踐，安全風險可控"
  ],
  "codex_analysis": {
    "session_id": "019bc004-eb95-7a91-9a5d-3202405cba56",
    "tokens_used": 38570,
    "root_cause": "window.angular undefined in Tampermonkey sandbox",
    "recommended_solution": "Use unsafeWindow.angular + waitForAngular()",
    "affected_lines": [704, 789, 896, 2413, 2506]
  }
}
