# Tasks: Add Search Filter to Move Dropdown

## Status: ✅ COMPLETED (2026-01-08)
**Git Commit**: 9503e39

## Overview

| 階段 | 任務數 | 狀態 |
|------|--------|------|
| Phase 1: UI 結構 | 3 | ✅ 完成 |
| Phase 2: 搜尋邏輯 | 3 | ✅ 完成 |
| Phase 3: 選擇與確認 | 2 | ✅ 完成 |
| Phase 4: 整合測試 | 2 | ✅ 完成 |
| **Total** | **10** | ✅ |

---

## Phase 1: UI 結構

### Task 1.1: 建立搜尋區塊容器
**目標**: 在 dropdown 頂部新增搜尋區塊的 DOM 結構

**修改檔案**: `src/shopline-category-manager.user.js`

**實作內容**:
- 新增 `createSearchSection()` 方法
- 建立搜尋區塊容器（包含輸入框、結果列表、確認按鈕）
- 在 `createDropdownContainer()` 或 `showMoveDropdown()` 中插入搜尋區塊

**驗證**:
- [x] 點擊「移動到」按鈕，浮動視窗頂部出現搜尋區塊
- [x] 搜尋區塊與樹狀選單之間有分隔線

---

### Task 1.2: 建立搜尋輸入框
**目標**: 建立搜尋輸入框 UI

**實作內容**:
- 輸入框樣式（寬度 100%、padding、border）
- Placeholder 文字：「🔍 搜尋父項目...」
- Focus 狀態樣式

**驗證**:
- [x] 輸入框正確顯示
- [x] 可以輸入文字
- [x] Focus 時有視覺回饋

---

### Task 1.3: 建立搜尋結果列表容器
**目標**: 建立顯示過濾結果的列表容器

**實作內容**:
- 結果列表容器（最大高度限制，可滾動）
- 空狀態顯示「無符合項目」
- 初始狀態顯示所有 Level 1 項目

**驗證**:
- [x] 結果列表區域正確顯示
- [x] 超過 5 項時可滾動
- [x] 空白搜尋顯示所有 Level 1 項目

---

## Phase 2: 搜尋邏輯

### Task 2.1: 實作 Level 1 分類過濾
**目標**: 建立只返回 Level 1 分類的方法

**實作內容**:
- 新增 `getLevel1Categories()` 方法
- 從 `this.categories` 和 `this.posCategories` 中提取 Level 1 項目
- 排除系統分類（`key` 屬性為 true）
- 排除當前分類（不能移動到自己）

**驗證**:
- [x] 只返回 Level 1 分類
- [x] 不包含系統分類
- [x] 不包含當前分類

---

### Task 2.2: 實作模糊搜尋過濾
**目標**: 建立模糊匹配過濾邏輯

**實作內容**:
- 新增 `filterCategories(keyword, categories)` 方法
- 模糊匹配：關鍵字是分類名稱的子字串
- 大小寫不敏感
- 空白關鍵字返回全部

**驗證**:
- [x] 輸入「鞋」匹配「運動鞋」
- [x] 輸入「ABC」匹配「abc分類」
- [x] 空白輸入返回所有 Level 1 項目

---

### Task 2.3: 綁定即時過濾事件
**目標**: 輸入時即時更新結果列表

**實作內容**:
- 監聽輸入框 `input` 事件
- 使用 debounce（200ms）避免頻繁過濾
- 更新結果列表 DOM

**驗證**:
- [x] 輸入文字後結果列表即時更新
- [x] 快速輸入時不會卡頓
- [x] 清空輸入後恢復顯示全部

---

## Phase 3: 選擇與確認

### Task 3.1: 實作選擇狀態管理
**目標**: 管理使用者選中的項目

**實作內容**:
- 追蹤當前選中的分類（單選）
- 點擊結果項目時更新選中狀態
- 選中項目高亮顯示（背景色變化）
- 點擊已選中項目可取消選擇

**驗證**:
- [x] 點擊項目後高亮顯示
- [x] 只能選中一個項目
- [x] 再次點擊可取消選擇

---

### Task 3.2: 實作確認按鈕與移動
**目標**: 確認按鈕控制與執行移動

**實作內容**:
- 確認按鈕初始為禁用狀態
- 選中項目後啟用按鈕
- 點擊按鈕呼叫現有 `moveCategory()` 方法
- 移動成功後關閉 dropdown

**驗證**:
- [x] 未選中時按鈕禁用
- [x] 選中後按鈕啟用
- [x] 點擊確認後分類成功移動
- [x] 移動後 dropdown 關閉

---

## Phase 4: 整合測試

### Task 4.1: 功能完整測試
**目標**: 驗證搜尋移動完整流程

**測試案例**:
1. 搜尋「鞋」→ 選中「運動鞋」→ 確認移動 → 分類移動到運動鞋下
2. 搜尋無結果 → 顯示「無符合項目」
3. 使用樹狀選單移動 → 仍可正常運作
4. 快速輸入多個字元 → 無性能問題

**驗證**:
- [x] 搜尋移動流程完整可用
- [x] 樹狀選單移動不受影響
- [x] 無 JavaScript 錯誤

---

### Task 4.2: 邊界案例測試
**目標**: 驗證邊界情況處理

**測試案例**:
1. 只有 1 個 Level 1 分類 → 正常顯示
2. 沒有 Level 1 分類 → 顯示「無可用項目」
3. 分類名稱很長 → 正確截斷或換行
4. 特殊字元搜尋（如 `&`、`<`）→ 無 XSS 問題

**驗證**:
- [x] 邊界案例正確處理
- [x] 無安全漏洞

---

## Dependencies

```
Task 1.1 ──→ Task 1.2 ──→ Task 1.3
                              │
                              ▼
Task 2.1 ──→ Task 2.2 ──→ Task 2.3
                              │
                              ▼
             Task 3.1 ──→ Task 3.2
                              │
                              ▼
             Task 4.1 ──→ Task 4.2
```

## Notes

- 所有修改集中在 `src/shopline-category-manager.user.js`
- 不需要新增外部依賴
- 使用現有的 `moveCategory()` 方法執行實際移動
- 搜尋區塊與樹狀選單獨立運作，互不干擾
