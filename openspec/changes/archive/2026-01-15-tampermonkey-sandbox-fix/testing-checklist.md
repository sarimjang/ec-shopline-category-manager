# Tampermonkey 沙箱修復 - 測試檢查清單

完整的測試計畫和驗收標準，用於驗證 Tampermonkey 沙箱修復的所有功能。

---

## 第一部分：環境準備

### 預設安裝檢查

- [ ] Chrome 已安裝（最新版本）
- [ ] Tampermonkey 擴充程式已安裝（最新版本）
- [ ] Tampermonkey Dashboard 可以開啟 (`chrome-extension://...`)
- [ ] Shopline Admin Panel 帳號已登入
- [ ] 瀏覽器 DevTools Console 可以開啟 (F12)

### 測試環境配置

```bash
# 驗證腳本版本
# 1. 在 Tampermonkey Dashboard 中檢查 "Shopline Category Manager"
# 2. 確認版本為 0.2.2 或以上
# 3. 檢查 "Run at" 設定為 "document-start" 或 "document-body"
```

### 測試清單

- [ ] 生成一份新的沙箱環境測試日誌檔案（命名: `test-log-{timestamp}.txt`）
- [ ] 清空瀏覽器 Cache 和 LocalStorage（Ctrl+Shift+Delete）
- [ ] 在 Tampermonkey Dashboard 中禁用其他影響分類管理的腳本

---

## 第二部分：整合測試案例

### 測試場景 A: 基本初始化

**目標**：驗證 `getAngular()` 和 `waitForAngular()` 正確運作

**前置條件**：
- Tampermonkey 開啟沙箱模式（已配置 @grant 權限）
- Shopline 分類管理頁面已開啟
- 瀏覽器 Console 已開啟

**測試步驟**：

1. [ ] 開啟 Shopline Admin Panel 分類管理頁面
   ```
   https://admin.shoplineapp.com/admin/*/categories
   ```

2. [ ] 觀察 Console 輸出（F12 打開 DevTools）
   - [ ] 應該看到：`[Shopline Category Manager] 正在初始化...`
   - [ ] 應該看到：`[Shopline Category Manager] ✓ AngularJS 已就緒`
   - [ ] 不應該看到任何紅色錯誤訊息（`Uncaught`）

3. [ ] 檢查是否有超時錯誤
   - [ ] 不應該看到：`AngularJS 載入超時`
   - [ ] 不應該看到：`初始化中止`

**驗收標準**：
- ✅ Console 顯示「✓ AngularJS 已就緒」
- ✅ 無任何紅色錯誤
- ✅ 頁面能正常載入和互動

---

### 測試場景 B: 按鈕顯示功能

**目標**：驗證「移動到」按鈕能正確注入到每個分類項目

**前置條件**：
- 場景 A 測試通過
- 分類管理頁面已完全載入
- 分類樹至少有 3 個項目

**測試步驟**：

1. [ ] 檢查頁面上是否有「移動到」按鈕
   - [ ] 每個分類項目都應該有一個「移動到」按鈕
   - [ ] 按鈕文字應為「移動到」
   - [ ] 按鈕應該在分類名稱的右側或下方

2. [ ] 計算按鈕總數
   - [ ] 記錄分類項目數量（記為 N）
   - [ ] 記錄「移動到」按鈕數量（應該等於 N）
   - 測試結果：___ 個按鈕，___ 個分類項目

3. [ ] 測試按鈕可點擊性
   - [ ] 點擊第一個「移動到」按鈕
   - [ ] 應該彈出選擇對話框
   - [ ] 對話框應顯示其他分類的列表

4. [ ] 檢查 Console 是否有相關警告
   - [ ] 不應該看到：`AngularJS 不可用，跳過按鈕注入`
   - [ ] 不應該看到：任何 `undefined` 錯誤

**驗收標準**：
- ✅ 所有分類項目都有「移動到」按鈕
- ✅ 按鈕能被點擊
- ✅ 按鈕點擊後能打開對話框
- ✅ Console 無相關錯誤

---

### 測試場景 C: 分類移動功能

**目標**：驗證分類移動的完整流程

**前置條件**：
- 場景 B 測試通過
- 至少有 2 層分類結構（如：主分類 > 子分類）

**測試步驟**：

1. [ ] 選擇一個子分類進行移動
   - [ ] 記錄分類名稱（記為 `Category A`）
   - [ ] 記錄原始父分類（記為 `Parent A`）
   - 測試分類：_______________

2. [ ] 點擊「移動到」按鈕
   - [ ] 應彈出分類選擇對話框
   - [ ] 對話框應顯示其他可用分類
   - [ ] 對話框應有「取消」按鈕

3. [ ] 選擇新的目標分類
   - [ ] 選擇一個不同的分類（記為 `Parent B`）
   - [ ] 點擊「確認」或「移動」按鈕

4. [ ] 驗證移動是否成功
   - [ ] 分類應該從 `Parent A` 移動到 `Parent B`
   - [ ] 頁面應該重新整理/更新樹結構
   - [ ] `Category A` 應該出現在 `Parent B` 下

5. [ ] 檢查 Console 輸出
   - [ ] 應該看到分類移動的相關日誌
   - [ ] 不應該看到任何紅色錯誤

6. [ ] 驗證移動後的時間追蹤訊息
   - [ ] 應該顯示「已節省 XX 秒」訊息（見場景 D）

**驗收標準**：
- ✅ 分類成功移動到新位置
- ✅ 樹結構正確更新
- ✅ 無移動相關的 JavaScript 錯誤
- ✅ 時間追蹤訊息正確顯示

---

### 測試場景 D: 時間追蹤功能

**目標**：驗證時間節省追蹤的正確計算和顯示

**前置條件**：
- 場景 C 測試通過（至少完成一次分類移動）
- Time Savings Tracker 已初始化

**測試步驟**：

1. [ ] 移動一個分類（見場景 C）

2. [ ] 觀察頁面上的時間節省訊息
   - [ ] 應該看到彈出通知（可能是 Toast 或 Alert）
   - [ ] 訊息應包含以下三行格式：
     ```
     ✓ 分類已移動
     已節省 XX 秒
     累計節省 XXX 秒
     ```

3. [ ] 記錄顯示的時間數據
   - 本次節省時間：_____ 秒
   - 累計節省時間：_____ 秒

4. [ ] 連續移動 3 個分類
   - [ ] 每次移動後都應看到更新的時間訊息
   - [ ] 累計時間應該遞增
   - 第 1 次：_____ 秒
   - 第 2 次：_____ 秒
   - 第 3 次：_____ 秒

5. [ ] 檢查 Console 中的時間追蹤日誌
   - [ ] 應該看到每次移動的時間戳記
   - [ ] 應該看到累計時間計算

**驗收標準**：
- ✅ 時間節省訊息按三行格式正確顯示
- ✅ 時間數據逐次增加
- ✅ 累計時間計算正確
- ✅ Console 無時間計算相關錯誤

---

### 測試場景 E: Tampermonkey 選單功能

**目標**：驗證 Tampermonkey 選單（使用 `@grant GM_registerMenuCommand`）正常工作

**前置條件**：
- 場景 D 測試通過（至少有累計時間數據）
- Tampermonkey 選單已啟用

**測試步驟**：

1. [ ] 找到 Tampermonkey 選單圖示
   - [ ] 應在瀏覽器工具欄上看到 Tampermonkey 圖示（紫色標籤）
   - [ ] 點擊圖示應展開選單

2. [ ] 查看選單項目
   - [ ] 應該看到「📊 查看統計」選項
   - [ ] 應該看到「🔄 重置統計」選項
   - [ ] 可能還有其他腳本的選單項目

3. [ ] 測試「查看統計」功能
   - [ ] 點擊「📊 查看統計」
   - [ ] 應彈出統計訊息窗口
   - [ ] 窗口應顯示累計移動次數和節省時間
   - 顯示的統計資料：
     ```
     ___________________________________
     ```

4. [ ] 驗證統計數據的準確性
   - [ ] 統計的累計時間應與之前記錄的相符
   - [ ] 統計的移動次數應正確

5. [ ] 測試「重置統計」功能
   - [ ] 點擊「🔄 重置統計」
   - [ ] 應彈出確認對話框（要求確認重置）
   - [ ] 點擊確認後，統計應重置為 0
   - [ ] 再次查看統計應顯示 0 數據

6. [ ] 移動一個分類後再次檢查統計
   - [ ] 統計應該重新開始累計
   - [ ] 新的統計數據應該正確

**驗收標準**：
- ✅ 選單項目能正確顯示
- ✅ 「查看統計」顯示正確的累計數據
- ✅ 「重置統計」能成功重置
- ✅ 重置後統計能正確重新開始計算

---

### 測試場景 F: 錯誤處理和邊界情況

**目標**：驗證應用能正確處理錯誤情況

**前置條件**：
- 場景 E 測試通過

**測試步驟**：

1. [ ] 測試 3 層限制驗證
   - [ ] 嘗試將第 3 層分類移動到第 2 層子分類下（成為第 4 層）
   - [ ] 應該看到錯誤訊息：`分類不能超過 3 層嵌套`
   - [ ] 移動應被禁止
   - 錯誤訊息：___________________________

2. [ ] 測試 AngularJS 不可用情況
   - [ ] （高級測試）在 Tampermonkey Dashboard 中暫時禁用腳本
   - [ ] 重新開啟分類管理頁面
   - [ ] 應該看到相關警告訊息
   - [ ] 應該看到「AngularJS 不可用」提示

3. [ ] 測試分類已被移除情況
   - [ ] 移動分類 A 到分類 B
   - [ ] 在移動進行時，從另一個標籤刪除分類 A
   - [ ] 應該看到錯誤處理
   - [ ] 應該看到友善的錯誤訊息（不是 JavaScript 錯誤）

4. [ ] 測試網路錯誤恢復
   - [ ] 移動一個分類
   - [ ] 在網路請求進行時斷開網路
   - [ ] 應該看到網路錯誤訊息
   - [ ] 應該能重試或取消

**驗收標準**：
- ✅ 3 層限制能正確驗證
- ✅ 所有錯誤訊息都是友善的中文訊息
- ✅ 無未捕獲的 JavaScript 異常
- ✅ 應用能從錯誤中恢復

---

## 第三部分：回歸測試案例

### 測試場景 G: 現有功能驗證

**目標**：確保修復不影響現有功能

**前置條件**：
- 所有整合測試已通過
- 使用 production 版本（`prod.user.js`）

**測試步驟**：

1. [ ] 驗證搜尋功能仍然正常
   - [ ] 在分類樹中點擊搜尋按鈕
   - [ ] 輸入關鍵字搜尋
   - [ ] 應該能找到相關分類
   - [ ] 點擊搜尋結果應該能移動分類

2. [ ] 驗證多層級分類移動仍然正常
   - [ ] 移動第 1 層分類到另一個第 1 層下
   - [ ] 移動第 2 層分類到另一個第 1 層下
   - [ ] 所有移動應該成功

3. [ ] 驗證層級驗證仍然正常
   - [ ] 嘗試超過 3 層的移動應該被禁止
   - [ ] 錯誤訊息應該清晰

4. [ ] 驗證 DOM 觀察器仍然正常
   - [ ] 在分類樹中新增一個分類
   - [ ] 新增的分類應該自動獲得「移動到」按鈕
   - [ ] 按鈕應該能正常使用

5. [ ] 驗證頁面互動仍然流暢
   - [ ] 展開/折疊分類不應有延遲
   - [ ] 滾動分類樹不應有卡頓
   - [ ] 整體 UI 響應應該迅速

**驗收標準**：
- ✅ 搜尋功能能正常使用
- ✅ 多層級移動能正常進行
- ✅ 層級驗證能正常工作
- ✅ DOM 觀察器能自動注入新元素
- ✅ 頁面互動流暢無卡頓

---

### 測試場景 H: 性能驗證

**目標**：驗證修復未引入明顯的效能衰退

**前置條件**：
- 場景 G 測試通過
- Tampermonkey Performance 標籤已開啟

**測試步驟**：

1. [ ] 測量初始化時間
   - [ ] 記錄頁面載入時間（開啟 DevTools Network 標籤）
   - [ ] 記錄腳本執行時間（Console 應顯示時間戳記）
   - 頁面載入時間：_____ ms
   - 腳本初始化時間：_____ ms

2. [ ] 測量 AngularJS 等待時間
   - [ ] 觀察 Console 中「✓ AngularJS 已就緒」的時間
   - [ ] 應該在 1-3 秒內出現
   - AngularJS 等待時間：_____ ms

3. [ ] 測量按鈕注入時間
   - [ ] 測量從頁面載入到按鈕出現的時間
   - [ ] 應該在 2-5 秒內完成
   - 按鈕注入時間：_____ ms

4. [ ] 測量分類移動操作時間
   - [ ] 開啟 DevTools Performance 標籤
   - [ ] 執行分類移動操作並記錄時間
   - [ ] 應該在 1-3 秒內完成
   - 分類移動時間：_____ ms

**驗收標準**：
- ✅ 頁面載入時間 < 5 秒
- ✅ AngularJS 等待時間 < 3 秒
- ✅ 按鈕注入時間 < 5 秒
- ✅ 分類移動時間 < 3 秒
- ✅ 無明顯的效能衰退

---

## 第四部分：跨瀏覽器測試

### 支援的瀏覽器

| 瀏覽器 | 版本 | 測試狀態 | 備註 |
|--------|------|--------|------|
| Chrome | 120+ | [ ] | Tampermonkey 官方支援 |
| Firefox | 121+ | [ ] | Greasemonkey 或 Tampermonkey |
| Edge | 120+ | [ ] | Tampermonkey 支援 |
| Safari | 17+ | [ ] | （如適用）|

### 瀏覽器特定測試

對每個支援的瀏覽器執行以下測試：

1. [ ] 基本初始化測試（場景 A）
2. [ ] 按鈕顯示功能（場景 B）
3. [ ] 分類移動功能（場景 C）
4. [ ] 錯誤處理測試（場景 F）

**測試紀錄**：

- **Chrome 120+**：測試日期 _____, 結果：❌ 失敗 / ⚠️ 部分 / ✅ 通過
- **Firefox 121+**：測試日期 _____, 結果：❌ 失敗 / ⚠️ 部分 / ✅ 通過
- **Edge 120+**：測試日期 _____, 結果：❌ 失敗 / ⚠️ 部分 / ✅ 通過

---

## 第五部分：驗收標準

### 必須滿足

- ✅ 所有整合測試通過（場景 A-F）
- ✅ 所有回歸測試通過（場景 G-H）
- ✅ 至少在一個主要瀏覽器上測試通過
- ✅ 無 JavaScript 錯誤（Console 無紅色錯誤）
- ✅ 時間追蹤功能正確工作
- ✅ Tampermonkey 選單功能正確工作

### 效能要求

- ✅ 頁面載入 + 初始化時間 < 5 秒
- ✅ AngularJS 等待時間 < 3 秒
- ✅ 分類移動操作 < 3 秒
- ✅ 無明顯的 UI 卡頓或延遲

### 品質要求

- ✅ 所有 Console 訊息使用繁體中文
- ✅ 所有錯誤訊息都是使用者友善的
- ✅ 無未捕獲的異常
- ✅ 代碼註釋完整

---

## 第六部分：測試環境設置

### 本地測試環境

```bash
# 1. 確保 Node.js 已安裝
node --version  # v14+

# 2. 驗證生產腳本語法
node -e "
  const fs = require('fs');
  const acorn = require('acorn');
  const code = fs.readFileSync('src/shopline-category-manager.prod.user.js', 'utf8');
  acorn.parse(code, {ecmaVersion: 2022, sourceType: 'script'});
  console.log('✅ 生產腳本語法正確');
"

# 3. 在 Tampermonkey 中安裝腳本
# 選項 A: 從本地文件安裝
#   在 Tampermonkey Dashboard 中，新增腳本 → 右側選擇本地文件
#
# 選項 B: 複製腳本內容
#   打開 src/shopline-category-manager.prod.user.js
#   全選複製內容
#   在 Tampermonkey Dashboard 新增腳本 → 粘貼內容
```

### 遠程測試環境

```bash
# 1. 推送到 GitHub（如已配置）
git add src/shopline-category-manager.prod.user.js
git commit -m "test: version for testing"
git push

# 2. 在瀏覽器中安裝遠程版本
# 在 Tampermonkey Dashboard 新增腳本 → 從 URL 安裝
# URL: https://raw.githubusercontent.com/sarimjang/shopline-category-manager/main/src/shopline-category-manager.prod.user.js
```

---

## 第七部分：測試後檢查清單

### 修復提交前

- [ ] 所有測試場景已執行並記錄
- [ ] 至少 90% 的測試案例通過
- [ ] 無未解決的 JavaScript 錯誤
- [ ] 沙箱修復代碼已同步到 `prod.user.js`
- [ ] CHANGELOG.md 已更新
- [ ] 提交訊息清晰說明修復內容

### 發佈前

- [ ] 所有測試場景在多個瀏覽器上通過
- [ ] 性能指標符合要求
- [ ] 用戶文檔已更新
- [ ] GitHub Release 已建立並附帶更新日誌

---

## 附錄：常見問題排解

### Q1: Console 顯示「AngularJS 不可用」

**可能原因**：
- Tampermonkey 沙箱未正確配置
- AngularJS 在腳本執行時尚未載入

**解決方案**：
1. 確認 `@grant GM_registerMenuCommand` 已添加
2. 檢查 Tampermonkey 是否為最新版本
3. 嘗試增加 `waitForAngular()` 的超時時間
4. 清除瀏覽器 cache 並重新載入

### Q2: 按鈕未出現

**可能原因**：
- 分類 DOM 尚未完全加載
- AngularJS 物件無法訪問

**解決方案**：
1. 等待 3-5 秒讓頁面完全加載
2. 檢查 Console 中是否有「AngularJS 已就緒」訊息
3. 手動重新整理頁面（F5）
4. 檢查其他腳本是否有衝突

### Q3: 分類移動失敗

**可能原因**：
- 網路連線問題
- API 伺服器錯誤
- 權限不足

**解決方案**：
1. 檢查 Console 中的錯誤訊息
2. 檢查 Network 標籤中的 API 請求
3. 嘗試重新登入 Shopline Admin
4. 聯繫項目維護者

---

## 測試完成簽名

| 項目 | 測試者 | 日期 | 簽名 |
|------|--------|------|------|
| 整合測試 | _______ | _________ | _______ |
| 回歸測試 | _______ | _________ | _______ |
| 跨瀏覽器測試 | _______ | _________ | _______ |
| 性能驗證 | _______ | _________ | _______ |
| 最終驗收 | _______ | _________ | _______ |

---

**最後更新**：2026-01-15
**準備者**：Claude Code (Codex CLI)
**狀態**：✅ 準備就緒，待實作後執行
