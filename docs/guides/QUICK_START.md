# Shopline Category Manager - 快速啟動指南

## 概述

Shopline Category Manager 是一個 Greasemonkey userscript，為 Shopline 後台分類管理頁面添加「快速移動」功能。使用者可以通過下拉選單快速將分類移動到其他位置，而不需要長距離拖拉。

## 核心功能

1. **「移動到」按鈕**: 在每個分類行的操作區新增按鈕
2. **層級感知下拉選單**: 顯示所有有效的目標分類，並排除：
   - 分類自己
   - 分類的所有子孫
   - Level 3 分類（最大層級）
3. **雙方案支持**:
   - 主方案：直接操作 AngularJS $scope 修改分類數據
   - 備案方案：若主方案失敗，使用 DragEvent 模擬拖拉
4. **使用者回饋**:
   - 成功時顯示綠色通知（2 秒自動消失）
   - 失敗時顯示紅色錯誤訊息（3 秒自動消失）
5. **持久化**: 所有變更自動保存到 Shopline 後台

## 安裝步驟

### 1. 安裝瀏覽器擴展

**Chrome/Chromium**:
- 安裝 [Tampermonkey](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobela)

**Firefox**:
- 安裝 [Greasemonkey](https://addons.mozilla.org/zh-TW/firefox/addon/greasemonkey/)

**Safari**:
- 安裝 [Tampermonkey for Safari](https://www.tampermonkey.net/)

### 2. 新增 Userscript

1. 複製 `/src/shopline-category-manager.user.js` 的全部內容
2. 在瀏覽器擴展中建立新腳本
3. 貼上代碼
4. 點擊保存

### 3. 驗證安裝

1. 進入 Shopline 後台分類管理頁面
2. 按 **F12** 打開開發者工具，切換到 Console 標籤
3. 應該看到類似這樣的訊息：
   ```
   [Shopline Category Manager] 正在初始化...
   [Shopline Category Manager] 樹容器已載入
   [Shopline Category Manager] 成功初始化
   [Shopline Category Manager] 找到 X 個根分類
   [Shopline Category Manager] CategoryManager 已初始化
   [Shopline Category Manager] UI 注入完成
   ```

4. 如果沒看到訊息，檢查：
   - Userscript 是否啟用
   - 頁面是否已完全載入
   - 瀏覽器是否允許腳本執行

## 基本使用

### 移動分類

1. **找到分類**: 在分類列表中找要移動的分類
2. **點擊按鈕**: 點擊分類行上的「📁 移動到 ▼」按鈕
3. **選擇目標**: 在下拉選單中選擇目標位置
   - **📂 根目錄**: 將分類移到頂層（Level 1）
   - **其他分類**: 將分類變成該分類的子分類
4. **確認**: 看到綠色成功訊息即表示操作完成

### 下拉選單說明

- **第一行**: 「📂 根目錄」（如果當前分類不是 Level 1）
- **無縮進的行**: Level 1 分類
- **一層縮進（├─）**: Level 2 分類
- **兩層縮進（├─ ├─）**: Level 3 分類

### 約束條件

以下分類無法作為移動目標：
- 分類本身（無法將分類移到自己）
- 分類的所有子孫（無法形成環狀結構）
- Level 3 分類（最深層級，無法再新增子層級）

## 使用場景

### 場景 1: 新分類放到錯誤位置

**問題**: 新建的分類出現在列表最底部，但應該放在第二層某個分類下

**解決**:
1. 點擊新分類的「移動到」按鈕
2. 選擇目標分類（作為母分類）
3. 完成！新分類立即出現在正確位置

### 場景 2: 整理分類結構

**問題**: 需要調整現有分類的層級結構

**解決**:
1. 點擊要移動的分類的「移動到」按鈕
2. 選擇新的母分類（或選擇「根目錄」）
3. 所有子分類自動隨之移動，層級關係保持

### 場景 3: 移動分類及其子分類

**問題**: 一個分類有多個子分類，全部需要移動

**解決**:
- 只需要移動母分類，所有子分類會自動跟隨

## 疑難排解

### 按鈕不出現

**檢查清單**:
1. Userscript 是否啟用？
   - 查看擴展管理頁面，確認腳本已啟用

2. Console 是否顯示初始化訊息？
   - 按 F12，查看 Console
   - 如果沒有訊息，可能頁面加載不完全

3. 頁面選擇器是否正確？
   - 檢查頁面是否有 `.angular-ui-tree` 容器
   - 如果沒有，頁面結構已變化，需要更新腳本

### 移動後分類回到原位置

**原因**: API 保存失敗

**檢查步驟**:
1. 按 F12，切換到 Network 標籤
2. 進行移動操作
3. 尋找 PUT/POST 到 `/categories` 的請求
4. 檢查回應狀態是否為 200/204（成功）
5. 如果是 4xx/5xx，說明伺服器拒絕了請求

### Console 顯示錯誤

**常見錯誤**:
- `"angular is undefined"`: AngularJS 未載入，稍等一下或重新整理
- `"Cannot read property 'scope'"`: 頁面選擇器有問題，聯繫開發者
- `"scope 無法存取"`: 可能頁面結構變化，自動切換到備案方案（DragEvent）

### 備案方案被觸發

**訊息**: 「分類移動成功！（使用備案方案）」

**說明**:
- 主方案（$scope）失敗，自動使用備案方案（DragEvent）
- 備案方案成功，分類已移動
- 這是正常的容錯機制

## 技術細節

### 主方案 (AngularJS $scope)

**流程**:
1. 存取 AngularJS scope
2. 在陣列中找到源分類的父容器
3. 移除源分類
4. 添加到目標分類的子陣列中
5. 調用 `$scope.$apply()` 觸發更新
6. Shopline 自動保存到後台

**優勢**: 直接修改資料模型，保證與 Shopline 同步

### 備案方案 (DragEvent 模擬)

**流程**:
1. 找到源分類和目標分類的 DOM 元素
2. 建立 DragEvent 事件序列
3. 依序觸發 dragstart → dragover → drop
4. angular-ui-tree 處理拖放邏輯
5. Shopline 自動保存到後台

**優勢**: 當 $scope 無法存取時的備用方案

## 架構概述

```
┌─────────────────────────────────────────┐
│    Shopline 分類管理頁面                  │
│  (angular-ui-tree, AngularJS $scope)   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│    CategoryManager 類                    │
│                                          │
│  • injectUI()           - 注入按鈕       │
│  • showMoveDropdown()   - 顯示選單       │
│  • moveCategory()       - 移動分類       │
│  • getValidMoveTargets()- 取得有效目標   │
└──────────────┬──────────────────────────┘
               │
       ┌───────┴────────┐
       │                │
       ▼                ▼
┌─────────────┐  ┌─────────────────┐
│ 主方案      │  │ 備案方案         │
│ ($scope)    │  │ (DragEvent)     │
│             │  │                 │
│ 修改陣列    │  │ 模擬拖拉        │
│ 觸發更新    │  │ 觸發原生邏輯    │
└─────────────┘  └─────────────────┘
       │                │
       └───────┬────────┘
               │
               ▼
    ┌─────────────────────┐
    │  Shopline 後台      │
    │  保存分類結構        │
    └─────────────────────┘
```

## 文件說明

- **src/shopline-category-manager.user.js**: 主腳本文件
- **IMPLEMENTATION_PLAN.md**: 詳細的測試計劃和實現步驟
- **TEST_GUIDE.md**: 完整的手動測試指南
- **QUICK_START.md**: 本文檔，快速參考

## 版本資訊

- **版本**: 0.1.0
- **上次更新**: 2026-01-07
- **相容性**: Shopline 新後台（使用 AngularJS 和 angular-ui-tree）
- **瀏覽器相容**: Chrome, Firefox, Safari（需要 Tampermonkey 或 Greasemonkey）

## 常見問題 (FAQ)

**Q: 可以同時移動多個分類嗎？**
A: 目前不支援。一次只能移動一個分類。

**Q: 移動後需要手動保存嗎？**
A: 不需要。變更會自動保存到 Shopline 後台。

**Q: 可以撤銷移動操作嗎？**
A: 不能。腳本沒有撤銷功能。如果誤操作，可以再次使用「移動到」功能修正。

**Q: 為什麼某些分類的按鈕是灰淡的？**
A: 那是特殊分類（有 `key` 屬性），Shopline 限制它們無法移動。

**Q: 移動分類時分類消失了，怎麼辦？**
A: 重新整理頁面（F5）。分類應該會回到新位置。

**Q: 按鈕出現但下拉選單不顯示，怎麼辦？**
A: 檢查 Console 是否有 JavaScript 錯誤。如果有錯誤，嘗試重新整理頁面。

## 聯繫支援

如果遇到問題，請：
1. 檢查 Console 日誌和錯誤訊息
2. 查看本文檔的「疑難排解」部分
3. 查看詳細的 TEST_GUIDE.md
4. 聯繫開發者提供 Console 截圖和詳細步驟

## 更新日誌

### v0.1.0 (2026-01-07)
- 初始版本
- 基礎功能：「移動到」按鈕和下拉選單
- 支援三層分類結構
- 雙方案錯誤處理
- 使用者回饋（成功/失敗訊息）
- 詳細的測試計劃和指南

## 貢獻指南

歡迎提交改進建議！請提供：
1. 問題描述
2. 重現步驟
3. Console 日誌
4. 預期行為 vs 實際行為

---

準備好開始了嗎？ 😊

1. 按照「安裝步驟」安裝腳本
2. 按「驗證安裝」檢查是否成功
3. 按「基本使用」開始使用
4. 參考 TEST_GUIDE.md 進行完整測試
