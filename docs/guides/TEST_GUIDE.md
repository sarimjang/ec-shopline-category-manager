# Shopline Category Manager - 測試指南

## 目的
本文檔提供詳細的手動測試步驟，用於驗證 Shopline 分類快速移動功能的完整性和正確性。

## 前置準備

### 1. 安裝 Userscript
1. 安裝瀏覽器擴展 (Tampermonkey 或類似工具)
2. 複製 `src/shopline-category-manager.user.js` 內容到新的 userscript
3. 保存並啟用腳本

### 2. 準備 Shopline 環境
1. 登入 Shopline 後台
2. 進入 **商品** → **商品分類** 頁面
3. 確保分類列表已完全載入（至少有 3 個分類，最好有多層結構）

### 3. 打開開發者工具
- 按下 **F12** 打開 DevTools
- 切換到 **Console** 標籤（用於查看日誌）
- 切換到 **Network** 標籤（用於監控 API）

---

## 測試場景

### 測試場景 1: 基礎功能

#### 1.1 頁面載入後按鈕出現

**預期結果**: 每個分類行都在操作按鈕區顯示「移動到」按鈕

**測試步驟**:

1. 刷新頁面（F5）
2. 在 Console 中查看日誌：
   ```
   [Shopline Category Manager] 正在初始化...
   [Shopline Category Manager] 樹容器已載入
   [Shopline Category Manager] 成功初始化
   [Shopline Category Manager] 找到 X 個根分類
   [Shopline Category Manager] CategoryManager 已初始化
   [Shopline Category Manager] UI 注入完成
   ```

3. 逐一檢查每個分類行：
   - 在分類名稱右側的操作按鈕區查看
   - 應該看到「移動到」按鈕（位於其他按鈕旁邊）

4. 向下滾動檢查所有分類（包括嵌套分類）

**失敗原因排查**:
- 如果沒看到日誌：Userscript 可能未啟用
- 如果日誌顯示錯誤：檢查 AngularJS 版本或頁面結構變化
- 如果按鈕未出現：檢查操作按鈕區的 CSS 選擇器（`.item-action`）

---

#### 1.2 點擊按鈕下拉選單顯示

**預期結果**: 點擊「移動到」按鈕後，在按鈕下方出現下拉選單，包含所有有效的目標分類

**測試步驟**:

1. 找到任意分類的「移動到」按鈕
2. 點擊按鈕
3. 觀察：
   - 下拉選單是否出現在按鈕正下方
   - 選單背景是白色，有邊框和陰影
   - 選單可以滾動（如果選項很多）

4. 檢查選單內容：
   - 第一個選項應該是「📂 根目錄」（如果當前分類不是 Level 1）
   - 後續選項應該是有效的分類名稱
   - 每個選項都應該可以被點擊和懸停

5. 移動滑鼠到選項上，檢查懸停效果：
   - 背景應該變成淺灰色（#f5f5f5）
   - 移開後恢復白色

**失敗原因排查**:
- 下拉選單未出現：檢查控制台是否有 JavaScript 錯誤
- 選單位置不對：檢查 CSS z-index 和定位
- 選項不完整：檢查 `getValidMoveTargets()` 邏輯

---

#### 1.3 下拉選單包含合法目標

**預期結果**: 下拉選單中包含所有應該出現的目標分類，並使用層級縮進

**測試步驟**:

1. 點擊某個分類的「移動到」按鈕，打開下拉選單
2. 分析選單中的選項：

   **對於 Level 1 或 Level 2 分類**:
   - 「📂 根目錄」應該出現在第一行（允許移到根目錄）
   - 其他 Level 1 分類應該無縮進
   - Level 1 分類的子分類應該有縮進（`  → `）
   - Level 2 分類的子分類應該有雙層縮進（`  → ` + `  → `）

   **對於 Level 3 分類**:
   - 「📂 根目錄」應該出現
   - Level 1 分類應該出現
   - Level 1 的 Level 2 子分類應該出現
   - Level 3 分類應該**不出現**（無法作為移動目標）

3. 驗證排除規則：
   - 當前分類本身不在選單中
   - 當前分類的所有子孫也不在選單中

**失敗原因排查**:
- 選項數量不對：檢查過濾邏輯
- 縮進不正確：檢查 `getValidMoveTargets()` 中的縮進邏輯
- 本應排除的選項仍出現：檢查 `isDescendant()` 函數

---

### 測試場景 2: 移動操作

#### 2.1 移動 Level 2 分類到根目錄

**前置條件**: 必須有至少一個 Level 2 分類（某個 Level 1 分類的子分類）

**預期結果**: 分類移動到列表頂部，成為 Level 1 分類

**測試步驟**:

1. 在分類列表中找一個 Level 2 分類（它應該在其父分類下縮進顯示）
2. 記住該分類的名稱和當前位置
3. 點擊該分類的「移動到」按鈕
4. 在下拉選單中點擊「📂 根目錄」
5. 觀察 UI 變化：
   - 應該看到右下角綠色成功提示：「分類移動成功！」
   - 提示應該在 1-2 秒後自動消失
6. 查看分類列表：
   - 該分類應該移動到根層級（不再縮進）
   - 該分類應該出現在列表中的適當位置

**驗證持久化**:

7. 打開 DevTools **Network** 標籤
8. 再次進行移動操作
9. 在 Network 中查找 API 請求：
   - 應該有一個 PUT 或 POST 請求到 `/categories` 或類似端點
   - 請求體應該包含分類資料
   - 響應狀態應該是 200 或 204（成功）

10. 重新整理頁面（F5）
11. 等待頁面載入完成
12. 驗證分類仍然在新位置（根層級）

**失敗原因排查**:
- 分類未移動：檢查 `moveCategoryUsingScope()` 方法
- 移動後重新整理回到舊位置：可能 API 保存失敗
- Console 出現錯誤：檢查 scope 存取或 $apply 是否成功

---

#### 2.2 移動分類到某個 Level 1 分類底下

**前置條件**: 必須有至少兩個 Level 1 分類

**預期結果**: 分類成為目標分類的子分類（Level 2），並在下拉列表中縮進顯示

**測試步驟**:

1. 找一個要移動的分類（可以是 Level 1 或 Level 2）
2. 記住名稱和當前位置
3. 點擊「移動到」按鈕
4. 在下拉選單中選擇一個 Level 1 分類（無縮進的選項）
5. 驗證移動：
   - 看到綠色成功提示
   - 分類現在應該在目標分類下縮進顯示
   - 分類應該變成 Level 2
6. 展開目標分類確認子分類在其下方

**驗證持久化**:

7. 重新整理頁面（F5）
8. 驗證分類仍在新位置

---

#### 2.3 移動分類到某個 Level 2 分類底下

**前置條件**: 必須有至少一個 Level 2 分類

**預期結果**: 分類成為目標分類的子分類（Level 3），使用雙層縮進

**測試步驟**:

1. 找要移動的分類
2. 記住名稱
3. 點擊「移動到」按鈕
4. 在下拉選單中選擇一個 Level 2 分類（有雙層縮進 `  →   → ` 的選項）
5. 驗證移動：
   - 綠色成功提示出現
   - 分類現在應該在 Level 2 分類下，使用雙層縮進顯示
   - 分類應該變成 Level 3

**驗證持久化**:

6. 重新整理頁面
7. 驗證分類仍在新位置（Level 3）

---

### 測試場景 3: 邏輯驗證

#### 3.1 無法將分類移到自己

**預期結果**: 在下拉選單中無法找到當前分類本身

**測試步驟**:

1. 點擊某個分類的「移動到」按鈕
2. 仔細檢查下拉選單中的所有選項
3. 確認該分類的名稱**不出現**在選單中
4. 對多個分類重複測試

**失敗原因排查**:
- 如果分類出現在選單中：檢查 `getValidMoveTargets()` 中的自我排除邏輯

---

#### 3.2 無法將分類移到自己的子孫

**前置條件**: 必須有有子分類的分類

**預期結果**: 分類的所有子孫（包括直接子分類和更深的後代）都不會出現在下拉選單中

**測試步驟**:

1. 找一個有子分類的分類（Level 1 有 Level 2 子分類）
2. 點擊該分類的「移動到」按鈕
3. 檢查下拉選單：
   - 該分類的直接子分類**不應該出現**
   - 子分類的子分類**也不應該出現**
   - 例如，如果分類結構是 A → B → C，點擊 A 的「移動到」按鈕時，B 和 C 都不應該出現

4. 在分類有多個層級時重複測試

**失敗原因排查**:
- 子孫仍出現在選單：檢查 `isDescendant()` 函數或調用位置

---

#### 3.3 Level 3 分類不出現在下拉選單中

**前置條件**: 必須有 Level 3 分類存在

**預期結果**: 任何分類的「移動到」下拉選單中都不包含 Level 3 分類

**測試步驟**:

1. 確認分類結構中有 Level 3 分類（A → B → C，其中 C 是 Level 3）
2. 點擊任意分類的「移動到」按鈕（不一定是 A, B, C）
3. 逐一檢查下拉選單中的所有選項
4. 確認**沒有任何 Level 3 分類**出現在選單中
5. 對多個分類重複此測試

**失敗原因排查**:
- 如果 Level 3 分類出現：檢查 `getValidMoveTargets()` 中的層級過濾邏輯

---

### 測試場景 4: 邊界情況

#### 4.1 分類有多個子分類，移動後仍保留子分類

**前置條件**: 找一個有多個子分類的分類

**預期結果**: 移動該分類後，它的所有子分類都隨之移動，層級關係保持不變

**測試步驟**:

1. 找一個有多個子分類的分類（例如 A 有子分類 B, C, D）
2. 記住子分類的數量和名稱
3. 執行移動操作（將 A 移到其他位置）
4. 展開 A，驗證：
   - 所有子分類都還在（B, C, D 仍然存在）
   - 子分類的相對位置未變化
   - 子分類的層級正確增加（如果 A 從 Level 1 變為 Level 2，則 B, C, D 從 Level 2 變為 Level 3）

5. 重新整理頁面，再次驗證子分類保留

---

#### 4.2 特殊分類（key 有值）按鈕被禁用

**前置條件**: 找一個有 `key` 屬性的特殊分類（例如 Shopline 內置的「精選商品」）

**預期結果**: 該分類的「移動到」按鈕應該被禁用或不可點擊

**測試步驟**:

1. 在分類列表中找一個特殊分類（通常是預設分類）
2. 查看該分類的「移動到」按鈕：
   - 按鈕外觀應該灰淡（disabled 狀態）
   - 按鈕不應該可點擊
3. 嘗試點擊按鈕，確認無反應
4. 檢查按鈕的 title 屬性，應該顯示「特殊分類不支援移動」

**失敗原因排查**:
- 按鈕仍可點擊：檢查 `attachButtonsToCategories()` 中的 `category.key` 檢查

---

#### 4.3 分類名稱很長，按鈕位置正確

**前置條件**: 找一個名稱較長的分類，或手動編輯一個分類使其名稱很長

**預期結果**: 按鈕不會被擠出視野，仍可正確點擊

**測試步驟**:

1. 找一個名稱很長的分類行
2. 查看操作按鈕區：
   - 「移動到」按鈕應該正常顯示
   - 按鈕應該與其他按鈕並排排列
   - 按鈕不應該被長名稱的文字覆蓋或隱藏
3. 嘗試點擊按鈕，確認可正常工作

---

### 測試場景 5: 持久化

#### 5.1 移動後重新整理頁面，變更維持

**預期結果**: 執行一次移動操作後，重新整理頁面，分類應該仍在新位置

**測試步驟**:

1. 選擇一個分類進行移動
2. 記住源位置和新位置
3. 點擊「移動到」按鈕，選擇目標，完成移動
4. 查看綠色成功提示
5. 驗證分類在新位置
6. 按 **F5** 重新整理頁面
7. 等待頁面完全載入（看到「[Shopline Category Manager] UI 注入完成」在 Console 中）
8. 向下滾動找到該分類
9. **關鍵驗證**: 確認分類仍在新位置，**未回到原位置**

**失敗原因排查**:
- 如果分類回到原位置：可能 API 保存失敗，檢查 Network 標籤中的錯誤響應

---

#### 5.2 檢查網路請求是否包含儲存

**預期結果**: 每次移動操作都應該發送正確的 API 請求到服務器

**測試步驟**:

1. 打開 DevTools **Network** 標籤
2. 過濾 API 請求（搜索 "categories" 或 "category"）
3. 執行一次分類移動操作
4. 在 Network 標籤中查找 API 請求：
   - 應該有一個 **PUT** 或 **POST** 請求
   - URL 應該包含 "categories" 或類似的端點
   - 例如：`https://xxx.shoplineapp.com/api/v1/admin/categories` 或類似

5. 點擊該請求查看詳細信息：
   - **Request** 標籤：查看請求體，應該包含分類資料（ID, 新位置等）
   - **Response** 標籤：應該返回成功狀態（200, 201, 204）和更新後的資料

6. 驗證響應中的資料是否反映了移動操作

**失敗原因排查**:
- 沒有看到 API 請求：可能 $apply 未觸發，或 Shopline 未發送保存請求
- API 返回錯誤狀態：檢查 Console 中是否有伺服器錯誤訊息
- API 成功但頁面未更新：可能 Shopline 的 UI 更新邏輯有問題

---

## 錯誤排查

### 常見問題和解決方案

#### 問題 1: 按鈕未出現

**症狀**: 分類行中沒有看到「移動到」按鈕

**排查步驟**:

1. 檢查 Console 日誌：
   ```javascript
   // 應該看到以下訊息
   [Shopline Category Manager] UI 注入完成
   ```

2. 如果沒有此訊息，檢查是否有錯誤：
   ```javascript
   // 如果看到以下錯誤
   [Shopline Category Manager] 找不到樹容器
   // 說明頁面結構已變化，.angular-ui-tree 選擇器不對
   ```

3. 打開 DevTools Elements 標籤，搜索 `.angular-ui-tree` 是否存在

**解決方案**:

- 如果 `.angular-ui-tree` 不存在，檢查 Shopline 頁面是否更新
- 更新 CSS 選擇器以匹配當前頁面結構
- 聯繫開發者重新檢查頁面選擇器

---

#### 問題 2: 下拉選單位置不對

**症狀**: 下拉選單出現在奇怪的位置，或被其他元素遮擋

**排查步驟**:

1. 檢查 z-index：
   - 下拉選單應該有 `z-index: 1000`
   - 確認沒有其他元素有更高的 z-index

2. 檢查是否有 CSS 衝突：
   - 在 DevTools 的 Elements 標籤中檢查下拉選單的應用樣式

**解決方案**:

- 增加 z-index 值
- 檢查 Shopline 的全局 CSS 是否干擾

---

#### 問題 3: 移動後回到原位置

**症狀**: 移動分類，然後重新整理頁面，分類回到原位置

**排查步驟**:

1. 檢查 Network 標籤中是否有保存請求
2. 如果有保存請求，檢查響應狀態：
   - 如果是 4xx 或 5xx，說明伺服器拒絕了請求
   - 查看響應體了解錯誤原因

3. 如果沒有保存請求，可能 $apply 未觸發

**解決方案**:

- 如果是 API 錯誤，檢查 Shopline 的伺服器日誌
- 如果是 $apply 問題，檢查 scope 是否正確存取

---

#### 問題 4: 下拉選單選項不完整

**症狀**: 下拉選單中缺少某些分類，或出現了不應該出現的分類

**排查步驟**:

1. 在 Console 中執行：
   ```javascript
   // 取得 CategoryManager 實例
   // （假設已在全局作用域中）
   const manager = window.categoryManager;

   // 檢查分類結構
   console.log(manager.categories);

   // 檢查層級計算
   manager.categories.forEach(cat => {
     console.log(cat.name, 'Level:', manager.getLevel(cat));
   });
   ```

2. 分析日誌，確認層級計算是否正確

**解決方案**:

- 如果層級計算錯誤，檢查 `getLevel()` 方法
- 如果子分類未被包括，檢查 `children` 陣列是否正確

---

#### 問題 5: Console 顯示 AngularJS 錯誤

**症狀**: Console 中出現與 AngularJS scope 相關的錯誤

**常見錯誤和解決**:

1. **"angular is undefined"**:
   - 說明 AngularJS 未載入
   - 檢查 Shopline 頁面是否真的使用 AngularJS
   - 檢查 userscript 的 `@run-at` 是否為 `document-end`

2. **"Cannot read property 'scope' of null"**:
   - 說明 DOM 元素與 AngularJS 綁定有問題
   - 檢查選擇器是否正確（`.angular-ui-tree`）

3. **"$apply already in progress"**:
   - 說明 $apply 呼叫時已有其他 $apply 在進行
   - 在 $apply 前檢查：
     ```javascript
     if (this.scope.$$phase) {
       // 已有其他 $apply 進行中
     } else {
       this.scope.$apply();
     }
     ```

---

## 測試總結檢查清單

完成以下所有測試後，在對應項標記完成：

### 基礎功能
- [ ] 1.1 頁面載入後按鈕出現
- [ ] 1.2 點擊按鈕下拉選單顯示
- [ ] 1.3 下拉選單包含合法目標

### 移動操作
- [ ] 2.1 移動 Level 2 分類到根目錄
- [ ] 2.2 移動分類到某個 Level 1 分類底下
- [ ] 2.3 移動分類到某個 Level 2 分類底下

### 邏輯驗證
- [ ] 3.1 無法將分類移到自己
- [ ] 3.2 無法將分類移到自己的子孫
- [ ] 3.3 Level 3 分類不出現在下拉選單中

### 邊界情況
- [ ] 4.1 分類有多個子分類，移動後仍保留子分類
- [ ] 4.2 特殊分類（key 有值）按鈕被禁用
- [ ] 4.3 分類名稱很長，按鈕位置正確

### 持久化
- [ ] 5.1 移動後重新整理頁面，變更維持
- [ ] 5.2 檢查網路請求是否包含儲存

### 錯誤處理
- [ ] Console 無紅色錯誤（除了無關的 Shopline 錯誤）
- [ ] 移動失敗時顯示紅色錯誤訊息
- [ ] 移動成功時顯示綠色成功訊息

### 相容性
- [ ] AngularJS 版本檢查通過
- [ ] angular-ui-tree 元素正確載入
- [ ] scope 可被正確存取
- [ ] categories 陣列存在且格式正確

---

## 額外測試

### 壓力測試
- 連續進行 5-10 次移動操作，確認沒有內存洩漏或崩潰

### 多用戶場景
- 在多個瀏覽器標籤頁同時打開分類管理頁面
- 在一個標籤進行移動操作，檢查另一個標籤是否自動更新

### 網路延遲場景
- 使用 DevTools Network 標籤限制速度（3G），進行移動操作
- 驗證在網路緩慢時是否有合理的超時處理

---

## 最終驗收標準

測試通過的標準：
1. ✅ 所有 5 大測試場景都通過
2. ✅ 所有邊界情況都正確處理
3. ✅ 持久化驗證通過
4. ✅ 無 console 錯誤
5. ✅ API 請求正確發送和響應
6. ✅ 使用者回饋清晰（成功/失敗訊息）
7. ✅ 相容性檢查通過

如果所有測試都通過，則該功能已準備好進入正式發布。
