# Cross-World Communication Message Schema

**Version**: 1.0  
**Last Updated**: 2026-01-29  
**Status**: OpenSpec CWC-003, CWC-004, CWC-005

This document defines the standardized message schema for all cross-world communication between the content script (isolated world) and the injected script (main world).

---

## Message Structure Overview

All cross-world messages follow this common structure:

```javascript
{
  type: string,              // Message type identifier
  payload: object,           // Type-specific message data
  source: string,            // Message source (scm-injected or scm-content-script)
  nonce: string,             // 32-character hex nonce (128-bit)
  signature: string          // Cryptographic signature (HMAC-SHA256 hex)
}
```

### Required Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | ✅ Yes | Message type identifier from catalog |
| `payload` | object | ✅ Yes | Non-empty object containing message-specific data |
| `source` | string | ✅ Yes | Must be `scm-injected` or `scm-content-script` |
| `nonce` | string | ✅ Yes | 32-character hex nonce (generated by NonceManager) |
| `signature` | string | ✅ Yes | Hex-encoded HMAC-SHA256 signature (may be empty for BASIC level) |

### Validation Rules

- **type**: Must be defined in Message Type Catalog (see below)
- **payload**: Must be a non-empty object (Object.keys(payload).length > 0)
- **source**: Must start with `scm-` prefix
- **nonce**: Must match regex `/^[0-9a-f]{32}$/` (32 hex characters)
- **signature**: Must be valid hex string or empty string

---

## Message Type Catalog

### 1. categoryManagerReady

**Purpose**: Notify that the category manager has successfully initialized.

**Severity**: CRITICAL  
**Direction**: `scm-injected` → `scm-content-script`  
**Frequency**: Once per page load

**Schema**:
```javascript
{
  type: 'categoryManagerReady',
  payload: {
    ready: true                // Indicates successful initialization
  },
  source: 'scm-injected',
  nonce: '4c9acf81e9a4c1a3d79f98ccf8016aaf',
  signature: 'abc123def456...'  // HMAC-SHA256 hex
}
```

**Validation**:
- `payload.ready` MUST be `true` (boolean)
- This is the first message sent after injected script loads
- Content script MUST validate nonce before accepting initialization

**Error Cases**:
```javascript
// ❌ Missing ready field
{ type: 'categoryManagerReady', payload: {}, ... }

// ❌ Wrong nonce
{ type: 'categoryManagerReady', payload: { ready: true }, nonce: 'wrongnonce', ... }

// ❌ Page script spoofing (nonce doesn't match injected value)
// → REJECTED: Nonce validation failed
```

**Example Flow**:
```
1. init.js generates nonce: "4c9acf81e9a4c1a3d79f98ccf8016aaf"
2. init.js injects: script.dataset.nonce = nonce
3. injected.js reads: const nonce = script.dataset.nonce
4. injected.js sends: CustomEvent('categoryManagerReady', { detail: {..., nonce} })
5. init.js validates: receivedNonce === expectedNonce ✓
6. Initialization proceeds
```

---

### 2. categoryMoved

**Purpose**: Notify that a user moved a category in the UI.

**Severity**: HIGH  
**Direction**: `scm-injected` → `scm-content-script`  
**Frequency**: Once per category move operation

**Schema**:
```javascript
{
  type: 'categoryMoved',
  payload: {
    fromId: string,            // Source category ID (number as string)
    toId: string,              // Target position category ID (or null for end)
    timestamp: number          // Unix timestamp in milliseconds
  },
  source: 'scm-injected',
  nonce: '6b440b74a2c1e5f9...',
  signature: 'def789abc123...'
}
```

**Payload Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `fromId` | string | ✅ Yes | The category ID being moved (numeric, as string) |
| `toId` | string | ⚠️ Optional | Target position ID; null means move to end |
| `timestamp` | number | ✅ Yes | Millisecond timestamp (Date.now()) |

**Validation**:
- `fromId` MUST be a valid numeric ID (matches `/^\d+$/)
- `toId` MUST be valid numeric ID OR null (not undefined)
- `timestamp` MUST be recent (within last 60 seconds)
- `fromId` MUST NOT equal `toId` (cannot move to same position)

**Error Cases**:
```javascript
// ❌ Missing timestamp
{ type: 'categoryMoved', payload: { fromId: '123', toId: '456' }, ... }

// ❌ Invalid fromId
{ type: 'categoryMoved', payload: { fromId: 'abc', toId: '456', timestamp }, ... }

// ❌ Tampered payload
// → Signature verification fails
```

**Example Flow**:
```
1. User drags category 123 below category 456
2. injected.js captures: { fromId: '123', toId: '456', timestamp: 1704067245000 }
3. Sends categoryMoved event
4. init.js receives and verifies:
   - Signature matches payload ✓
   - Nonce is valid ✓
   - Timestamp is recent ✓
5. Processes the move operation
```

---

### 3. syncCategories

**Purpose**: Synchronize category list state from the page back to extension storage.

**Severity**: MEDIUM  
**Direction**: `scm-injected` → `scm-content-script`  
**Frequency**: On demand, usually after operations complete

**Schema**:
```javascript
{
  type: 'syncCategories',
  payload: {
    categories: [
      {
        id: string,            // Category ID (numeric, as string)
        name: string,          // Category name from page
        parent_id: string|null // Parent category ID or null for root
      },
      // ... more categories
    ]
  },
  source: 'scm-injected',
  nonce: '7d551c85b3d2f6a0...',
  signature: 'ghi456def789...'
}
```

**Payload Fields**:

| Field | Type | Required | Notes |
|-------|------|----------|-------|
| `categories` | array | ✅ Yes | Array of category objects |
| `categories[].id` | string | ✅ Yes | Numeric ID as string |
| `categories[].name` | string | ✅ Yes | Category display name |
| `categories[].parent_id` | string\|null | ✅ Yes | Parent ID or null |

**Validation**:
- `categories` MUST be non-empty array
- Each category MUST have `id`, `name`, `parent_id`
- `id` values MUST be unique within array
- `id` MUST match `/^\d+$/` (numeric)
- `name` MUST be non-empty string (max 255 chars)
- `parent_id` MUST be valid `id` from same array OR null
- No circular references (parent chains MUST terminate)

**Error Cases**:
```javascript
// ❌ Empty categories
{ type: 'syncCategories', payload: { categories: [] }, ... }

// ❌ Missing name
{ type: 'syncCategories', payload: { categories: [{ id: '123', parent_id: null }] }, ... }

// ❌ Circular reference (123 → 456 → 123)
{ type: 'syncCategories', payload: { categories: [
  { id: '123', name: 'Cat A', parent_id: '456' },
  { id: '456', name: 'Cat B', parent_id: '123' }
] }, ... }
```

**Example Flow**:
```
1. injected.js reads category list from DOM
2. Transforms to payload format
3. Sends syncCategories event
4. init.js verifies:
   - All categories valid ✓
   - No circular refs ✓
   - Signature matches ✓
5. Updates chrome.storage.local with new state
```

---

## Validation Rules by Field

### type Field
- Value from Message Type Catalog
- Case-sensitive exact match required
- Valid values: `categoryManagerReady`, `categoryMoved`, `syncCategories`

### payload Field
- MUST be object (not array, not null)
- MUST have at least one property: `Object.keys(payload).length > 0`
- No reserved prefixes or special handling

### source Field
- Format: `scm-<identifier>`
- Valid sources:
  - `scm-injected`: Sent from main world injected script
  - `scm-content-script`: Sent from isolated world content script
- Case-sensitive

### nonce Field
- Format: `/^[0-9a-f]{32}$/` (32 hexadecimal characters)
- Exactly 128 bits when decoded
- MUST match nonce injected by content script
- Subject to one-time use (cannot be reused)
- Expires after 5 minutes

### signature Field
- Format: Hex string (lowercase)
- Generated by MessageSigner using HMAC-SHA256
- For BASIC security level: can be empty string `""`
- For MODERATE security level: required if signing key available
- For STRICT security level: always required
- Excludes signature field itself from cryptographic operations

---

## Security Levels & Validation

### BASIC Level
- ✅ Structure validation
- ✅ Nonce validation (format + value check)
- ❌ Signature verification (optional)

**Rejection**: Invalid type, missing payload, wrong nonce

### MODERATE Level
- ✅ Structure validation
- ✅ Nonce validation
- ⚠️ Signature verification (if signing key available)

**Rejection**: Invalid structure, wrong nonce, invalid signature (if enabled)

### STRICT Level
- ✅ Structure validation
- ✅ Nonce validation
- ✅ Signature verification (required)

**Rejection**: Any validation failure

---

## Error Codes & Messages

### Structure Validation Errors

| Error Code | Message | Example |
|-----------|---------|---------|
| `MISSING_TYPE` | Missing required field: type | `{ payload, source, nonce, signature }` |
| `MISSING_PAYLOAD` | Missing required field: payload | `{ type, source, nonce, signature }` |
| `MISSING_SOURCE` | Missing required field: source | `{ type, payload, nonce, signature }` |
| `MISSING_NONCE` | Missing required field: nonce | `{ type, payload, source, signature }` |
| `MISSING_SIGNATURE` | Missing required field: signature | `{ type, payload, source, nonce }` |
| `INVALID_TYPE` | Invalid message type: xyz | type not in catalog |
| `INVALID_PAYLOAD` | Payload must be a non-empty object | `payload: []` or `payload: {}` |
| `INVALID_SOURCE` | Source must start with "scm-" | `source: "unknown"` |
| `INVALID_NONCE_FORMAT` | Nonce must be 32 hex characters | `nonce: "abc"` |
| `INVALID_SIGNATURE_FORMAT` | Signature must be hex string | non-hex characters |

### Runtime Validation Errors

| Error Code | Message | Cause |
|-----------|---------|-------|
| `NONCE_MISMATCH` | Nonce validation failed: value does not match injected nonce | Page script using wrong nonce |
| `NONCE_ALREADY_USED` | Nonce validation failed: nonce already consumed | Attempt to replay message |
| `NONCE_EXPIRED` | Nonce validation failed: nonce expired (TTL exceeded) | Nonce older than 5 minutes |
| `SIGNATURE_INVALID` | Signature verification failed | Payload was tampered, wrong key |
| `SIGNATURE_VERIFICATION_ERROR` | Error during signature verification | Crypto API failure |

### Payload Validation Errors

| Error Code | Message | Cause |
|-----------|---------|-------|
| `INVALID_CATEGORY_ID` | Invalid category ID format | Non-numeric ID |
| `MISSING_CATEGORY_DATA` | Missing required field: {field} | Missing id, name, or parent_id |
| `INVALID_PARENT_REFERENCE` | Invalid parent_id reference | parent_id doesn't exist |
| `CIRCULAR_REFERENCE_DETECTED` | Circular reference in categories | Parent chain loops |
| `TIMESTAMP_OUT_OF_RANGE` | Timestamp is too old or in future | >60s old or future date |

---

## Usage Examples

### Example 1: Valid Initialization

```javascript
// Content script generates nonce
const nonce = nonceManager.generate();  // "a1b2c3d4..."

// Injects into script tag
script.dataset.nonce = nonce;

// Injected script reads nonce
const injectedNonce = document.currentScript.dataset.nonce;

// Creates and sends message
const message = {
  type: 'categoryManagerReady',
  payload: { ready: true },
  source: 'scm-injected',
  nonce: injectedNonce,
  signature: ''  // BASIC level, no signing
};

// Content script validates
if (event.detail.nonce === expectedNonce) {
  // ✅ Proceed with initialization
}
```

### Example 2: Page Script Attack (Rejected)

```javascript
// Page script tries to spoof message
window.dispatchEvent(new CustomEvent('categoryManagerReady', {
  detail: {
    type: 'categoryManagerReady',
    payload: { ready: true },
    source: 'scm-injected',
    nonce: 'ffffffffffffffffffffffffffffffff',  // ❌ Wrong nonce
    signature: ''
  }
}));

// Content script validation
// ❌ REJECTED: Nonce does not match injected value
// → No initialization proceeds
```

### Example 3: Category Move with Signature

```javascript
// Injected script captures move operation
const message = {
  type: 'categoryMoved',
  payload: {
    fromId: '42',
    toId: '37',
    timestamp: 1704067245000
  },
  source: 'scm-injected',
  nonce: 'a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4',
  signature: '7c8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c...'
};

// Content script verification flow
const validator = new CrossWorldValidator({ securityLevel: 'strict' });
const result = await validator.validateMessage(message);

if (result.valid) {
  // ✅ All validations passed:
  // - Structure valid
  // - Nonce matches and is one-time use
  // - Signature verified
  // Proceed with category move
} else {
  // ❌ Validation failed
  console.error('Message rejected:', result.errors);
}
```

---

## Related Documentation

- **NonceManager**: `src/shared/security/nonce-manager.js`
- **MessageValidator**: `src/shared/security/message-validator.js`
- **MessageSigner**: `src/shared/security/message-signer.js`
- **CrossWorldValidator**: `src/shared/security/cross-world-validator.js`
- **OpenSpec CWC**: `openspec/changes/harden-api-isolation/specs/cross-world-communication/spec.md`

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-01-29 | Initial schema definition for Phase 1.7 |

---

**Last Updated**: 2026-01-29  
**OpenSpec Reference**: CWC-003, CWC-004, CWC-005  
**Maintained By**: Security Hardening Working Group
